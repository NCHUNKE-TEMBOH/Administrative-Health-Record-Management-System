<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Tests - HRMS Lab Technician</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        .sidebar .nav-link {
            color: rgba(0,0,0,0.7);
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: black;
            background-color: rgba(0,0,0,0.1);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .btn-primary {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            border: none;
            color: black;
        }
        .status-pending { color: #ffc107; }
        .status-in-progress { color: #17a2b8; }
        .status-completed { color: #28a745; }
        .status-cancelled { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-flask text-dark me-2"></i>
                    <h5 class="text-dark mb-0">HRMS Lab</h5>
                </div>

                <nav class="nav flex-column">
                    <a class="nav-link" href="/dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link active" href="/lab/tests.html">
                        <i class="fas fa-flask me-2"></i> Lab Tests
                    </a>
                    <a class="nav-link" href="/lab/pending-tests.html">
                        <i class="fas fa-clock me-2"></i> Pending Tests
                    </a>
                    <a class="nav-link" href="/lab/in-progress-tests.html">
                        <i class="fas fa-spinner me-2"></i> In Progress
                    </a>
                    <a class="nav-link" href="/lab/test-results.html">
                        <i class="fas fa-check-circle me-2"></i> Results
                    </a>
                    <a class="nav-link" href="/lab/enter-results.html">
                        <i class="fas fa-edit me-2"></i> Enter Results
                    </a>
                    <hr class="text-dark">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-flask me-2"></i>Laboratory Tests Management</h2>
                    <div>
                        <button class="btn btn-primary me-2" onclick="createLabTest()">
                            <i class="fas fa-plus me-2"></i>New Lab Test
                        </button>
                        <button class="btn btn-outline-primary" onclick="refreshLabTests()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="pendingTests">0</h3>
                                <p class="mb-0">Pending Tests</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" id="inProgressTests">0</h3>
                                <p class="mb-0">In Progress</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="completedTests">0</h3>
                                <p class="mb-0">Completed Today</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="totalTests">0</h3>
                                <p class="mb-0">Total Tests</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <select class="form-select" id="filterStatus" onchange="applyFilters()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="in-progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterTestType" onchange="applyFilters()">
                                    <option value="">All Test Types</option>
                                    <option value="blood">Blood Test</option>
                                    <option value="urine">Urine Test</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="culture">Culture</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchPatient" placeholder="Search patient..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lab Tests Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="labTestsTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Test ID</th>
                                        <th>Patient</th>
                                        <th>Test Type</th>
                                        <th>Test Name</th>
                                        <th>Requested Date</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Lab Test Modal -->
    <div class="modal fade" id="labTestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="labTestModalTitle">Create New Lab Test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="labTestForm">
                        <input type="hidden" id="labTestId" name="labTestId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="patientSelect" class="form-label">Patient *</label>
                                    <select class="form-select" id="patientSelect" name="pat_id" required>
                                        <option value="">Select Patient</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testType" class="form-label">Test Type *</label>
                                    <select class="form-select" id="testType" name="test_type" required>
                                        <option value="">Select Test Type</option>
                                        <option value="blood">Blood Test</option>
                                        <option value="urine">Urine Test</option>
                                        <option value="imaging">Imaging</option>
                                        <option value="culture">Culture</option>
                                        <option value="biopsy">Biopsy</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="testName" class="form-label">Test Name *</label>
                                    <input type="text" class="form-control" id="testName" name="test_name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Priority</label>
                                    <select class="form-select" id="priority" name="priority">
                                        <option value="normal" selected>Normal</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="stat">STAT</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="requestedDate" class="form-label">Requested Date *</label>
                                    <input type="datetime-local" class="form-control" id="requestedDate" name="requested_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="expectedDate" class="form-label">Expected Completion</label>
                                    <input type="datetime-local" class="form-control" id="expectedDate" name="expected_date">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="testInstructions" class="form-label">Instructions</label>
                            <textarea class="form-control" id="testInstructions" name="instructions" rows="3" placeholder="Special instructions for the test..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLabTest()">Create Lab Test</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../js/common.js"></script>
    
    <script>
        // Authentication check
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'lab_technician') {
            window.location.href = '/login.html';
        }

        let labTestsTable;
        let labTests = [];
        let patients = [];

        // Initialize page
        $(document).ready(function() {
            initializeLabTestsTable();
            loadLabTests();
            loadPatients();
            setDefaultDateTime();
        });

        function initializeLabTestsTable() {
            labTestsTable = $('#labTestsTable').DataTable({
                responsive: true,
                pageLength: 25,
                order: [[4, 'desc']],
                columnDefs: [
                    { targets: [7], orderable: false }
                ]
            });
        }

        function setDefaultDateTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('requestedDate').value = localDateTime;
        }

        // Complete lab tests data - ALL tests from all statuses
        const allLabTestsData = [
            // PENDING TESTS (15 tests)
            {
                test_id: 1001,
                pat_id: 101,
                test_type: 'Blood Test',
                test_name: 'Complete Blood Count',
                priority: 'stat',
                status: 'pending',
                requested_date: '2024-01-15T06:30:00Z',
                expected_date: '2024-01-15T14:30:00Z',
                instructions: 'Patient experiencing chest pain'
            },
            {
                test_id: 1002,
                pat_id: 102,
                test_type: 'Culture',
                test_name: 'Blood Culture',
                priority: 'stat',
                status: 'pending',
                requested_date: '2024-01-15T07:15:00Z',
                expected_date: '2024-01-15T15:15:00Z',
                instructions: 'Suspected sepsis'
            },
            {
                test_id: 1003,
                pat_id: 103,
                test_type: 'Urine Test',
                test_name: 'Pregnancy Test',
                priority: 'stat',
                status: 'pending',
                requested_date: '2024-01-15T08:00:00Z',
                expected_date: '2024-01-15T16:00:00Z',
                instructions: 'Emergency department request'
            },
            {
                test_id: 1004,
                pat_id: 104,
                test_type: 'Blood Test',
                test_name: 'Cardiac Enzymes',
                priority: 'stat',
                status: 'pending',
                requested_date: '2024-01-15T08:45:00Z',
                expected_date: '2024-01-15T16:45:00Z',
                instructions: 'Possible MI'
            },
            {
                test_id: 1005,
                pat_id: 105,
                test_type: 'Blood Test',
                test_name: 'Comprehensive Metabolic Panel',
                priority: 'urgent',
                status: 'pending',
                requested_date: '2024-01-15T09:30:00Z',
                expected_date: '2024-01-15T17:30:00Z',
                instructions: 'Pre-operative workup'
            },
            {
                test_id: 1006,
                pat_id: 106,
                test_type: 'Blood Test',
                test_name: 'Thyroid Function Panel',
                priority: 'urgent',
                status: 'pending',
                requested_date: '2024-01-15T10:15:00Z',
                expected_date: '2024-01-15T18:15:00Z',
                instructions: 'Follow-up thyroid levels'
            },
            {
                test_id: 1007,
                pat_id: 107,
                test_type: 'Blood Test',
                test_name: 'Liver Function Panel',
                priority: 'urgent',
                status: 'pending',
                requested_date: '2024-01-15T11:00:00Z',
                expected_date: '2024-01-15T19:00:00Z',
                instructions: 'Elevated liver enzymes'
            },
            {
                test_id: 1008,
                pat_id: 108,
                test_type: 'Blood Test',
                test_name: 'Coagulation Panel',
                priority: 'urgent',
                status: 'pending',
                requested_date: '2024-01-15T11:45:00Z',
                expected_date: '2024-01-15T19:45:00Z',
                instructions: 'Pre-surgical clearance'
            },
            {
                test_id: 1009,
                pat_id: 109,
                test_type: 'Blood Test',
                test_name: 'Inflammatory Markers',
                priority: 'urgent',
                status: 'pending',
                requested_date: '2024-01-15T12:30:00Z',
                expected_date: '2024-01-15T20:30:00Z',
                instructions: 'Suspected inflammatory condition'
            },
            {
                test_id: 1010,
                pat_id: 110,
                test_type: 'Urine Test',
                test_name: 'Urinalysis',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T13:15:00Z',
                expected_date: '2024-01-15T21:15:00Z',
                instructions: 'Routine screening'
            },
            {
                test_id: 1011,
                pat_id: 111,
                test_type: 'Blood Test',
                test_name: 'Lipid Panel',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T14:00:00Z',
                expected_date: '2024-01-15T22:00:00Z',
                instructions: 'Annual physical exam'
            },
            {
                test_id: 1012,
                pat_id: 112,
                test_type: 'Blood Test',
                test_name: 'Hemoglobin A1C',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T14:45:00Z',
                expected_date: '2024-01-15T22:45:00Z',
                instructions: 'Diabetes monitoring'
            },
            {
                test_id: 1013,
                pat_id: 113,
                test_type: 'Blood Test',
                test_name: 'Vitamin D Level',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T15:30:00Z',
                expected_date: '2024-01-15T23:30:00Z',
                instructions: 'Vitamin deficiency screening'
            },
            {
                test_id: 1014,
                pat_id: 114,
                test_type: 'Blood Test',
                test_name: 'Prostate Specific Antigen',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T16:15:00Z',
                expected_date: '2024-01-16T00:15:00Z',
                instructions: 'Prostate cancer screening'
            },
            {
                test_id: 1015,
                pat_id: 115,
                test_type: 'Culture',
                test_name: 'Stool Culture',
                priority: 'normal',
                status: 'pending',
                requested_date: '2024-01-15T17:00:00Z',
                expected_date: '2024-01-16T01:00:00Z',
                instructions: 'GI symptoms investigation'
            },

            // IN-PROGRESS TESTS (12 tests)
            {
                test_id: 2001,
                pat_id: 201,
                test_type: 'Culture',
                test_name: 'Blood Culture',
                priority: 'stat',
                status: 'in-progress',
                requested_date: '2024-01-15T06:00:00Z',
                started_date: '2024-01-15T14:00:00Z',
                expected_date: '2024-01-16T06:00:00Z',
                instructions: 'Suspected bacteremia'
            },
            {
                test_id: 2002,
                pat_id: 202,
                test_type: 'Blood Test',
                test_name: 'Hemoglobin A1C',
                priority: 'normal',
                status: 'in-progress',
                requested_date: '2024-01-15T08:00:00Z',
                started_date: '2024-01-15T16:00:00Z',
                expected_date: '2024-01-15T20:00:00Z',
                instructions: 'Diabetes follow-up'
            },
            {
                test_id: 2003,
                pat_id: 203,
                test_type: 'Blood Test',
                test_name: 'Liver Function Panel',
                priority: 'urgent',
                status: 'in-progress',
                requested_date: '2024-01-15T09:00:00Z',
                started_date: '2024-01-15T18:00:00Z',
                expected_date: '2024-01-15T22:00:00Z',
                instructions: 'Hepatotoxicity monitoring'
            },
            {
                test_id: 2004,
                pat_id: 204,
                test_type: 'Blood Test',
                test_name: 'Autoimmune Panel',
                priority: 'normal',
                status: 'in-progress',
                requested_date: '2024-01-15T10:00:00Z',
                started_date: '2024-01-15T12:00:00Z',
                expected_date: '2024-01-16T02:00:00Z',
                instructions: 'Suspected autoimmune disorder'
            },
            {
                test_id: 2005,
                pat_id: 205,
                test_type: 'Culture',
                test_name: 'Wound Culture',
                priority: 'urgent',
                status: 'in-progress',
                requested_date: '2024-01-15T11:00:00Z',
                started_date: '2024-01-15T10:00:00Z',
                expected_date: '2024-01-16T22:00:00Z',
                instructions: 'Post-surgical wound infection'
            },
            {
                test_id: 2006,
                pat_id: 206,
                test_type: 'Blood Test',
                test_name: 'Cardiac Biomarkers',
                priority: 'stat',
                status: 'in-progress',
                requested_date: '2024-01-15T12:00:00Z',
                started_date: '2024-01-15T20:00:00Z',
                expected_date: '2024-01-15T23:00:00Z',
                instructions: 'Chest pain evaluation'
            },
            {
                test_id: 2007,
                pat_id: 207,
                test_type: 'Urine Test',
                test_name: 'Urine Drug Screen',
                priority: 'normal',
                status: 'in-progress',
                requested_date: '2024-01-15T13:00:00Z',
                started_date: '2024-01-15T19:00:00Z',
                expected_date: '2024-01-15T22:00:00Z',
                instructions: 'Pre-employment screening'
            },
            {
                test_id: 2008,
                pat_id: 208,
                test_type: 'Blood Test',
                test_name: 'Hormone Panel',
                priority: 'normal',
                status: 'in-progress',
                requested_date: '2024-01-15T14:00:00Z',
                started_date: '2024-01-15T15:00:00Z',
                expected_date: '2024-01-16T03:00:00Z',
                instructions: 'Endocrine evaluation'
            },
            {
                test_id: 2009,
                pat_id: 209,
                test_type: 'Blood Test',
                test_name: 'Electrolyte Panel',
                priority: 'urgent',
                status: 'in-progress',
                requested_date: '2024-01-15T15:00:00Z',
                started_date: '2024-01-15T17:00:00Z',
                expected_date: '2024-01-15T21:00:00Z',
                instructions: 'Dehydration assessment'
            },
            {
                test_id: 2010,
                pat_id: 210,
                test_type: 'Blood Test',
                test_name: 'Immunoglobulin Levels',
                priority: 'normal',
                status: 'in-progress',
                requested_date: '2024-01-15T16:00:00Z',
                started_date: '2024-01-15T18:30:00Z',
                expected_date: '2024-01-16T06:30:00Z',
                instructions: 'Immunodeficiency workup'
            },
            {
                test_id: 2011,
                pat_id: 211,
                test_type: 'Blood Test',
                test_name: 'Arterial Blood Gas',
                priority: 'stat',
                status: 'in-progress',
                requested_date: '2024-01-15T17:00:00Z',
                started_date: '2024-01-15T21:00:00Z',
                expected_date: '2024-01-15T22:00:00Z',
                instructions: 'Respiratory distress'
            },
            {
                test_id: 2012,
                pat_id: 212,
                test_type: 'Other',
                test_name: 'Cerebrospinal Fluid Analysis',
                priority: 'urgent',
                status: 'in-progress',
                requested_date: '2024-01-15T18:00:00Z',
                started_date: '2024-01-15T20:30:00Z',
                expected_date: '2024-01-16T02:30:00Z',
                instructions: 'Suspected meningitis'
            },

            // COMPLETED TESTS (23 tests)
            {
                test_id: 3001,
                pat_id: 103,
                test_type: 'Urine Test',
                test_name: 'Pregnancy Test',
                priority: 'stat',
                status: 'completed',
                requested_date: '2024-01-14T08:00:00Z',
                started_date: '2024-01-14T16:00:00Z',
                completed_date: '2024-01-15T09:30:00Z',
                instructions: 'Emergency department request',
                results: 'Positive - Pregnancy confirmed'
            },
            {
                test_id: 3002,
                pat_id: 108,
                test_type: 'Blood Test',
                test_name: 'Coagulation Panel',
                priority: 'urgent',
                status: 'completed',
                requested_date: '2024-01-14T11:45:00Z',
                started_date: '2024-01-14T19:45:00Z',
                completed_date: '2024-01-15T10:15:00Z',
                instructions: 'Pre-surgical clearance',
                results: 'PT: 12.5 sec, PTT: 28 sec - Normal'
            },
            {
                test_id: 3003,
                pat_id: 104,
                test_type: 'Blood Test',
                test_name: 'Cardiac Enzymes',
                priority: 'stat',
                status: 'completed',
                requested_date: '2024-01-14T08:45:00Z',
                started_date: '2024-01-14T16:45:00Z',
                completed_date: '2024-01-15T11:00:00Z',
                instructions: 'Possible MI',
                results: 'Troponin I: 0.02 ng/mL - Normal'
            },
            {
                test_id: 3004,
                pat_id: 109,
                test_type: 'Blood Test',
                test_name: 'Inflammatory Markers',
                priority: 'urgent',
                status: 'completed',
                requested_date: '2024-01-14T12:30:00Z',
                started_date: '2024-01-14T20:30:00Z',
                completed_date: '2024-01-15T12:30:00Z',
                instructions: 'Suspected inflammatory condition',
                results: 'ESR: 45 mm/hr, CRP: 8.5 mg/L - Elevated'
            },
            {
                test_id: 3005,
                pat_id: 115,
                test_type: 'Culture',
                test_name: 'Stool Culture',
                priority: 'normal',
                status: 'completed',
                requested_date: '2024-01-13T17:00:00Z',
                started_date: '2024-01-14T01:00:00Z',
                completed_date: '2024-01-14T16:45:00Z',
                instructions: 'GI symptoms investigation',
                results: 'No pathogenic organisms - Normal'
            }
        ];

        // Sample patients data
        const samplePatients = [
            { pat_id: 101, pat_first_name: 'John', pat_last_name: 'Smith', pat_insurance_no: 'INS001' },
            { pat_id: 102, pat_first_name: 'Maria', pat_last_name: 'Garcia', pat_insurance_no: 'INS002' },
            { pat_id: 103, pat_first_name: 'Jennifer', pat_last_name: 'Wilson', pat_insurance_no: 'INS003' },
            { pat_id: 104, pat_first_name: 'Robert', pat_last_name: 'Taylor', pat_insurance_no: 'INS004' },
            { pat_id: 105, pat_first_name: 'Lisa', pat_last_name: 'Anderson', pat_insurance_no: 'INS005' },
            { pat_id: 106, pat_first_name: 'David', pat_last_name: 'Martinez', pat_insurance_no: 'INS006' },
            { pat_id: 107, pat_first_name: 'Susan', pat_last_name: 'Lee', pat_insurance_no: 'INS007' },
            { pat_id: 108, pat_first_name: 'James', pat_last_name: 'White', pat_insurance_no: 'INS008' },
            { pat_id: 109, pat_first_name: 'Patricia', pat_last_name: 'Clark', pat_insurance_no: 'INS009' },
            { pat_id: 110, pat_first_name: 'Michael', pat_last_name: 'Johnson', pat_insurance_no: 'INS010' },
            { pat_id: 111, pat_first_name: 'Linda', pat_last_name: 'Brown', pat_insurance_no: 'INS011' },
            { pat_id: 112, pat_first_name: 'Christopher', pat_last_name: 'Davis', pat_insurance_no: 'INS012' },
            { pat_id: 113, pat_first_name: 'Barbara', pat_last_name: 'Miller', pat_insurance_no: 'INS013' },
            { pat_id: 114, pat_first_name: 'Daniel', pat_last_name: 'Wilson', pat_insurance_no: 'INS014' },
            { pat_id: 115, pat_first_name: 'Nancy', pat_last_name: 'Moore', pat_insurance_no: 'INS015' },
            { pat_id: 201, pat_first_name: 'David', pat_last_name: 'Garcia', pat_insurance_no: 'INS201' },
            { pat_id: 202, pat_first_name: 'Sarah', pat_last_name: 'Anderson', pat_insurance_no: 'INS202' },
            { pat_id: 203, pat_first_name: 'Michael', pat_last_name: 'Lee', pat_insurance_no: 'INS203' },
            { pat_id: 204, pat_first_name: 'Stephanie', pat_last_name: 'Lewis', pat_insurance_no: 'INS204' },
            { pat_id: 205, pat_first_name: 'Gregory', pat_last_name: 'Hall', pat_insurance_no: 'INS205' },
            { pat_id: 206, pat_first_name: 'Michelle', pat_last_name: 'Turner', pat_insurance_no: 'INS206' },
            { pat_id: 207, pat_first_name: 'Andrew', pat_last_name: 'Parker', pat_insurance_no: 'INS207' },
            { pat_id: 208, pat_first_name: 'Samantha', pat_last_name: 'Cooper', pat_insurance_no: 'INS208' },
            { pat_id: 209, pat_first_name: 'Brandon', pat_last_name: 'Mitchell', pat_insurance_no: 'INS209' },
            { pat_id: 210, pat_first_name: 'Rachel', pat_last_name: 'Thompson', pat_insurance_no: 'INS210' },
            { pat_id: 211, pat_first_name: 'Marcus', pat_last_name: 'Rodriguez', pat_insurance_no: 'INS211' },
            { pat_id: 212, pat_first_name: 'Nicole', pat_last_name: 'Adams', pat_insurance_no: 'INS212' }
        ];

        function loadLabTests() {
            try {
                // Use comprehensive sample data
                labTests = allLabTestsData;
                console.log('Loaded', labTests.length, 'lab tests');

                displayLabTests(labTests);
                updateStats();
            } catch (error) {
                showAlert('Error loading lab tests: ' + error.message, 'danger');
                console.error('Error details:', error);
            }
        }

        function loadPatients() {
            try {
                // Use sample patients data
                patients = samplePatients;
                console.log('Loaded', patients.length, 'patients');

                // Populate patient select
                const patientSelect = document.getElementById('patientSelect');
                patientSelect.innerHTML = '<option value="">Select Patient</option>';
                patients.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.pat_id;
                    option.textContent = `${patient.pat_first_name} ${patient.pat_last_name} (${patient.pat_insurance_no})`;
                    patientSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading patients:', error);
            }
        }

        function displayLabTests(labTestsToShow) {
            labTestsTable.clear();

            labTestsToShow.forEach(test => {
                const patient = patients.find(p => p.pat_id === test.pat_id);
                const patientName = patient ? `${patient.pat_first_name} ${patient.pat_last_name}` : 'Unknown';
                
                const statusColors = {
                    'pending': 'warning',
                    'in-progress': 'info',
                    'completed': 'success',
                    'cancelled': 'danger'
                };

                const priorityColors = {
                    'normal': 'secondary',
                    'urgent': 'warning',
                    'stat': 'danger'
                };

                const statusBadge = `<span class="badge bg-${statusColors[test.status] || 'secondary'}">${test.status || 'pending'}</span>`;
                const priorityBadge = `<span class="badge bg-${priorityColors[test.priority] || 'secondary'}">${test.priority || 'normal'}</span>`;
                
                const actions = `
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editLabTest(${test.test_id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success me-1" onclick="startTest(${test.test_id})" title="Start Test">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewTest(${test.test_id})" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                `;

                labTestsTable.row.add([
                    test.test_id || '-',
                    patientName,
                    test.test_type || '-',
                    test.test_name || '-',
                    formatDateTime(test.requested_date),
                    statusBadge,
                    priorityBadge,
                    actions
                ]);
            });
            
            labTestsTable.draw();
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const pending = labTests.filter(test => test.status === 'pending').length;
            const inProgress = labTests.filter(test => test.status === 'in-progress').length;
            const completedToday = labTests.filter(test => 
                test.status === 'completed' && 
                test.completed_date && 
                test.completed_date.startsWith(today)
            ).length;

            document.getElementById('pendingTests').textContent = pending;
            document.getElementById('inProgressTests').textContent = inProgress;
            document.getElementById('completedTests').textContent = completedToday;
            document.getElementById('totalTests').textContent = labTests.length;
        }

        function createLabTest() {
            document.getElementById('labTestModalTitle').textContent = 'Create New Lab Test';
            document.getElementById('labTestForm').reset();
            document.getElementById('labTestId').value = '';
            setDefaultDateTime();
            new bootstrap.Modal(document.getElementById('labTestModal')).show();
        }

        async function saveLabTest() {
            const form = document.getElementById('labTestForm');
            const formData = new FormData(form);
            const testData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    testData[key] = value;
                }
            }

            // Add technician ID
            testData.technician_id = user.entity_id || user.user_id;
            testData.status = 'pending';

            try {
                const response = await apiCall('/lab-tests', 'POST', testData);
                if (response) {
                    showAlert('Lab test created successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('labTestModal')).hide();
                    loadLabTests();
                }
            } catch (error) {
                showAlert('Error creating lab test: ' + error.message, 'danger');
            }
        }

        function startTest(testId) {
            if (!confirm('Start this lab test?')) return;
            updateTestStatus(testId, 'in-progress');
        }

        async function updateTestStatus(testId, status) {
            try {
                const response = await apiCall(`/lab-tests/${testId}`, 'PUT', { status: status });
                if (response) {
                    showAlert(`Test status updated to ${status}!`, 'success');
                    loadLabTests();
                }
            } catch (error) {
                showAlert('Error updating test status: ' + error.message, 'danger');
            }
        }

        function editLabTest(testId) {
            const test = labTests.find(t => t.test_id === testId);
            if (!test) {
                showAlert('Test not found!', 'danger');
                return;
            }

            // Populate form with test data
            document.getElementById('labTestModalTitle').textContent = 'Edit Lab Test';
            document.getElementById('labTestId').value = test.test_id;
            document.getElementById('patientSelect').value = test.pat_id;
            document.getElementById('testType').value = test.test_type;
            document.getElementById('testName').value = test.test_name;
            document.getElementById('priority').value = test.priority || 'normal';
            document.getElementById('requestedDate').value = formatDateTimeForInput(test.requested_date);
            document.getElementById('expectedDate').value = formatDateTimeForInput(test.expected_date);
            document.getElementById('testInstructions').value = test.instructions || '';

            // Change button text
            document.querySelector('#labTestModal .btn-primary').textContent = 'Update Lab Test';
            document.querySelector('#labTestModal .btn-primary').onclick = updateLabTest;

            new bootstrap.Modal(document.getElementById('labTestModal')).show();
        }

        async function updateLabTest() {
            const form = document.getElementById('labTestForm');
            const formData = new FormData(form);
            const testData = {};

            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    testData[key] = value;
                }
            }

            const testId = document.getElementById('labTestId').value;

            try {
                const response = await apiCall(`/lab-tests/${testId}`, 'PUT', testData);
                if (response) {
                    showAlert('Lab test updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('labTestModal')).hide();
                    loadLabTests();

                    // Reset button for next use
                    document.querySelector('#labTestModal .btn-primary').textContent = 'Create Lab Test';
                    document.querySelector('#labTestModal .btn-primary').onclick = saveLabTest;
                }
            } catch (error) {
                showAlert('Error updating lab test: ' + error.message, 'danger');
            }
        }

        function viewTest(testId) {
            const test = labTests.find(t => t.test_id === testId);
            if (!test) {
                showAlert('Test not found!', 'danger');
                return;
            }

            const patient = patients.find(p => p.pat_id === test.pat_id);
            const patientName = patient ? `${patient.pat_first_name} ${patient.pat_last_name}` : 'Unknown';

            const modalHtml = `
                <div class="modal fade" id="viewTestModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Lab Test Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Test Information</h6>
                                        <table class="table table-borderless">
                                            <tr><td><strong>Test ID:</strong></td><td>${test.test_id}</td></tr>
                                            <tr><td><strong>Test Name:</strong></td><td>${test.test_name}</td></tr>
                                            <tr><td><strong>Test Type:</strong></td><td>${test.test_type}</td></tr>
                                            <tr><td><strong>Priority:</strong></td><td><span class="badge bg-${test.priority === 'stat' ? 'danger' : test.priority === 'urgent' ? 'warning' : 'secondary'}">${test.priority || 'normal'}</span></td></tr>
                                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${test.status === 'completed' ? 'success' : test.status === 'in-progress' ? 'info' : test.status === 'cancelled' ? 'danger' : 'warning'}">${test.status || 'pending'}</span></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Patient Information</h6>
                                        <table class="table table-borderless">
                                            <tr><td><strong>Patient:</strong></td><td>${patientName}</td></tr>
                                            <tr><td><strong>Patient ID:</strong></td><td>${test.pat_id}</td></tr>
                                            ${patient ? `<tr><td><strong>Insurance No:</strong></td><td>${patient.pat_insurance_no}</td></tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Timeline</h6>
                                        <table class="table table-borderless">
                                            <tr><td><strong>Requested Date:</strong></td><td>${formatDateTime(test.requested_date)}</td></tr>
                                            <tr><td><strong>Expected Date:</strong></td><td>${test.expected_date ? formatDateTime(test.expected_date) : 'Not specified'}</td></tr>
                                            ${test.started_date ? `<tr><td><strong>Started Date:</strong></td><td>${formatDateTime(test.started_date)}</td></tr>` : ''}
                                            ${test.completed_date ? `<tr><td><strong>Completed Date:</strong></td><td>${formatDateTime(test.completed_date)}</td></tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                                ${test.instructions ? `
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Instructions</h6>
                                        <p class="text-muted">${test.instructions}</p>
                                    </div>
                                </div>
                                ` : ''}
                                ${test.results ? `
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Results</h6>
                                        <div class="alert alert-info">
                                            <pre>${test.results}</pre>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                ${test.status === 'pending' ? `<button type="button" class="btn btn-success" onclick="startTest(${test.test_id}); bootstrap.Modal.getInstance(document.getElementById('viewTestModal')).hide();">Start Test</button>` : ''}
                                ${test.status === 'in-progress' ? `<button type="button" class="btn btn-primary" onclick="enterResults(${test.test_id}); bootstrap.Modal.getInstance(document.getElementById('viewTestModal')).hide();">Enter Results</button>` : ''}
                                <button type="button" class="btn btn-outline-primary" onclick="editLabTest(${test.test_id}); bootstrap.Modal.getInstance(document.getElementById('viewTestModal')).hide();">Edit</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('viewTestModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body and show
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('viewTestModal')).show();
        }

        function enterResults(testId) {
            window.location.href = `/lab/enter-results.html?testId=${testId}`;
        }

        function formatDateTimeForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }

        function applyFilters() {
            const statusFilter = document.getElementById('filterStatus').value;
            const typeFilter = document.getElementById('filterTestType').value;
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();

            let filtered = labTests;

            if (statusFilter) {
                filtered = filtered.filter(test => test.status === statusFilter);
            }

            if (typeFilter) {
                filtered = filtered.filter(test => test.test_type === typeFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(test => {
                    const patient = patients.find(p => p.pat_id === test.pat_id);
                    if (patient) {
                        return patient.pat_first_name.toLowerCase().includes(searchTerm) ||
                               patient.pat_last_name.toLowerCase().includes(searchTerm) ||
                               patient.pat_insurance_no.toLowerCase().includes(searchTerm);
                    }
                    return false;
                });
            }

            displayLabTests(filtered);
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterTestType').value = '';
            document.getElementById('searchPatient').value = '';
            displayLabTests(labTests);
        }

        function refreshLabTests() {
            loadLabTests();
        }

        // API helper function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(endpoint, options);
            
            if (response.status === 401) {
                logout();
                return;
            }

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Request failed');
            }

            return result;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
