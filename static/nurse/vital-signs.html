<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vital Signs - HRMS Nurse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .btn-primary {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
        }
        .vital-card {
            transition: transform 0.2s;
        }
        .vital-card:hover {
            transform: translateY(-2px);
        }
        .vital-normal { color: #28a745; }
        .vital-warning { color: #ffc107; }
        .vital-critical { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-3">
                <div class="d-flex align-items-center mb-4">
                    <i class="fas fa-user-nurse text-white me-2"></i>
                    <h5 class="text-white mb-0">HRMS Nurse</h5>
                </div>

                <nav class="nav flex-column">
                    <a class="nav-link" href="/dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="/nurse/patients.html">
                        <i class="fas fa-user-injured me-2"></i> My Patients
                    </a>
                    <a class="nav-link active" href="/nurse/vital-signs.html">
                        <i class="fas fa-heartbeat me-2"></i> Vital Signs
                    </a>
                    <a class="nav-link" href="/nurse/assignments.html">
                        <i class="fas fa-clipboard-list me-2"></i> Assignments
                    </a>
                    <a class="nav-link" href="/nurse/nursing-notes.html">
                        <i class="fas fa-notes-medical me-2"></i> Nursing Notes
                    </a>
                    <hr class="text-white-50">
                    <a class="nav-link" href="#" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-heartbeat me-2"></i>Vital Signs Management</h2>
                    <div>
                        <button class="btn btn-primary me-2" onclick="recordVitalSigns()">
                            <i class="fas fa-plus me-2"></i>Record Vital Signs
                        </button>
                        <button class="btn btn-outline-primary" onclick="refreshVitalSigns()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" id="todayRecords">0</h3>
                                <p class="mb-0">Today's Records</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" id="normalVitals">0</h3>
                                <p class="mb-0">Normal Vitals</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" id="warningVitals">0</h3>
                                <p class="mb-0">Warning Vitals</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger" id="criticalVitals">0</h3>
                                <p class="mb-0">Critical Vitals</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="filterDate" onchange="applyFilters()">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="filterPatient" onchange="applyFilters()">
                                    <option value="">All Patients</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchPatient" placeholder="Search patient..." onkeyup="applyFilters()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vital Signs Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="vitalSignsTable" class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Patient</th>
                                        <th>Temperature</th>
                                        <th>Blood Pressure</th>
                                        <th>Heart Rate</th>
                                        <th>Respiratory Rate</th>
                                        <th>Oxygen Saturation</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be loaded via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Record Vital Signs Modal -->
    <div class="modal fade" id="vitalSignsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="vitalSignsModalTitle">Record Vital Signs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vitalSignsForm">
                        <input type="hidden" id="vitalSignsId" name="vitalSignsId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="patientSelect" class="form-label">Patient *</label>
                                    <select class="form-select" id="patientSelect" name="pat_id" required>
                                        <option value="">Select Patient</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="recordedDate" class="form-label">Date & Time *</label>
                                    <input type="datetime-local" class="form-control" id="recordedDate" name="recorded_date" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="temperature" class="form-label">Temperature (°F)</label>
                                    <input type="number" class="form-control" id="temperature" name="temperature" step="0.1" min="90" max="110">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="heartRate" class="form-label">Heart Rate (bpm)</label>
                                    <input type="number" class="form-control" id="heartRate" name="heart_rate" min="30" max="200">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="systolicBP" class="form-label">Systolic BP (mmHg)</label>
                                    <input type="number" class="form-control" id="systolicBP" name="blood_pressure_systolic" min="70" max="250">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="diastolicBP" class="form-label">Diastolic BP (mmHg)</label>
                                    <input type="number" class="form-control" id="diastolicBP" name="blood_pressure_diastolic" min="40" max="150">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="respiratoryRate" class="form-label">Respiratory Rate (breaths/min)</label>
                                    <input type="number" class="form-control" id="respiratoryRate" name="respiratory_rate" min="8" max="40">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="oxygenSaturation" class="form-label">Oxygen Saturation (%)</label>
                                    <input type="number" class="form-control" id="oxygenSaturation" name="oxygen_saturation" min="70" max="100">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="vitalNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="vitalNotes" name="notes" rows="3" placeholder="Additional observations or notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVitalSigns()">Save Vital Signs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="../js/common.js"></script>
    
    <script>
        // Authentication check
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!token || user.role !== 'nurse') {
            window.location.href = '/login.html';
        }

        let vitalSignsTable;
        let vitalSigns = [];
        let patients = [];

        // Initialize page
        $(document).ready(function() {
            initializeVitalSignsTable();
            loadVitalSigns();
            loadPatients();
            setDefaultDateTime();
        });

        function initializeVitalSignsTable() {
            vitalSignsTable = $('#vitalSignsTable').DataTable({
                responsive: true,
                pageLength: 25,
                order: [[0, 'desc']],
                columnDefs: [
                    { targets: [8], orderable: false }
                ]
            });
        }

        function setDefaultDateTime() {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('recordedDate').value = localDateTime;
        }

        async function loadVitalSigns() {
            try {
                // Try to load from API first
                let response;
                try {
                    response = await apiCall('/vital-signs');
                    vitalSigns = response || [];
                } catch (error) {
                    console.log('API not available, using sample data');
                    vitalSigns = getSampleVitalSigns();
                }

                displayVitalSigns(vitalSigns);
                updateStats();
            } catch (error) {
                console.error('Error loading vital signs:', error);
                vitalSigns = getSampleVitalSigns();
                displayVitalSigns(vitalSigns);
                updateStats();
            }
        }

        function getSampleVitalSigns() {
            const now = new Date();
            const today = new Date().toISOString().split('T')[0];

            return [
                {
                    vital_id: 1,
                    pat_id: 1,
                    temperature: 98.6,
                    blood_pressure_systolic: 120,
                    blood_pressure_diastolic: 80,
                    heart_rate: 72,
                    respiratory_rate: 16,
                    oxygen_saturation: 98,
                    recorded_date: `${today}T08:30:00`,
                    notes: 'Patient stable, normal vitals',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 2,
                    pat_id: 2,
                    temperature: 101.2,
                    blood_pressure_systolic: 160,
                    blood_pressure_diastolic: 95,
                    heart_rate: 88,
                    respiratory_rate: 20,
                    oxygen_saturation: 95,
                    recorded_date: `${today}T09:15:00`,
                    notes: 'Elevated temperature and BP, monitoring closely',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 3,
                    pat_id: 3,
                    temperature: 99.1,
                    blood_pressure_systolic: 135,
                    blood_pressure_diastolic: 85,
                    heart_rate: 76,
                    respiratory_rate: 18,
                    oxygen_saturation: 97,
                    recorded_date: `${today}T10:00:00`,
                    notes: 'Post-operative monitoring, vitals improving',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 4,
                    pat_id: 4,
                    temperature: 98.4,
                    blood_pressure_systolic: 118,
                    blood_pressure_diastolic: 75,
                    heart_rate: 68,
                    respiratory_rate: 14,
                    oxygen_saturation: 99,
                    recorded_date: `${today}T11:30:00`,
                    notes: 'Excellent recovery progress',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 5,
                    pat_id: 5,
                    temperature: 98.8,
                    blood_pressure_systolic: 125,
                    blood_pressure_diastolic: 82,
                    heart_rate: 70,
                    respiratory_rate: 16,
                    oxygen_saturation: 98,
                    recorded_date: `${today}T12:45:00`,
                    notes: 'Stable condition, medication effective',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 6,
                    pat_id: 6,
                    temperature: 100.1,
                    blood_pressure_systolic: 140,
                    blood_pressure_diastolic: 90,
                    heart_rate: 82,
                    respiratory_rate: 22,
                    oxygen_saturation: 94,
                    recorded_date: `${today}T13:20:00`,
                    notes: 'Pneumonia treatment ongoing, slight improvement',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 7,
                    pat_id: 7,
                    temperature: 98.2,
                    blood_pressure_systolic: 130,
                    blood_pressure_diastolic: 78,
                    heart_rate: 74,
                    respiratory_rate: 16,
                    oxygen_saturation: 98,
                    recorded_date: `${today}T14:10:00`,
                    notes: 'Diabetes management effective, stable vitals',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 8,
                    pat_id: 8,
                    temperature: 98.0,
                    blood_pressure_systolic: 115,
                    blood_pressure_diastolic: 70,
                    heart_rate: 65,
                    respiratory_rate: 14,
                    oxygen_saturation: 99,
                    recorded_date: `${today}T15:00:00`,
                    notes: 'Post-surgical recovery excellent',
                    nurse_id: user.user_id
                },
                // Yesterday's records
                {
                    vital_id: 9,
                    pat_id: 1,
                    temperature: 98.4,
                    blood_pressure_systolic: 118,
                    blood_pressure_diastolic: 78,
                    heart_rate: 70,
                    respiratory_rate: 16,
                    oxygen_saturation: 98,
                    recorded_date: new Date(Date.now() - 86400000).toISOString().slice(0, 16) + ':00',
                    notes: 'Routine morning vitals',
                    nurse_id: user.user_id
                },
                {
                    vital_id: 10,
                    pat_id: 2,
                    temperature: 100.8,
                    blood_pressure_systolic: 155,
                    blood_pressure_diastolic: 92,
                    heart_rate: 85,
                    respiratory_rate: 19,
                    oxygen_saturation: 96,
                    recorded_date: new Date(Date.now() - 86400000).toISOString().slice(0, 16) + ':00',
                    notes: 'Condition improving from yesterday',
                    nurse_id: user.user_id
                }
            ];
        }

        async function loadPatients() {
            try {
                let response;
                try {
                    response = await apiCall('/patient');
                    patients = response || [];
                } catch (error) {
                    console.log('API not available, using sample patients');
                    patients = getSamplePatients();
                }

                // Populate patient selects
                const patientSelects = ['patientSelect', 'filterPatient'];
                patientSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = selectId === 'filterPatient' ? '<option value="">All Patients</option>' : '<option value="">Select Patient</option>';
                        patients.forEach(patient => {
                            const option = document.createElement('option');
                            option.value = patient.pat_id;
                            option.textContent = `${patient.pat_first_name} ${patient.pat_last_name} (${patient.pat_insurance_no || 'N/A'})`;
                            select.appendChild(option);
                        });
                        select.value = currentValue;
                    }
                });
            } catch (error) {
                console.error('Error loading patients:', error);
                patients = getSamplePatients();
            }
        }

        function getSamplePatients() {
            return [
                {
                    pat_id: 1,
                    pat_first_name: 'John',
                    pat_last_name: 'Doe',
                    pat_insurance_no: 'INS001'
                },
                {
                    pat_id: 2,
                    pat_first_name: 'Jane',
                    pat_last_name: 'Smith',
                    pat_insurance_no: 'INS002'
                },
                {
                    pat_id: 3,
                    pat_first_name: 'Robert',
                    pat_last_name: 'Wilson',
                    pat_insurance_no: 'INS003'
                },
                {
                    pat_id: 4,
                    pat_first_name: 'Mary',
                    pat_last_name: 'Johnson',
                    pat_insurance_no: 'INS004'
                },
                {
                    pat_id: 5,
                    pat_first_name: 'David',
                    pat_last_name: 'Brown',
                    pat_insurance_no: 'INS005'
                },
                {
                    pat_id: 6,
                    pat_first_name: 'Sarah',
                    pat_last_name: 'Davis',
                    pat_insurance_no: 'INS006'
                },
                {
                    pat_id: 7,
                    pat_first_name: 'Michael',
                    pat_last_name: 'Garcia',
                    pat_insurance_no: 'INS007'
                },
                {
                    pat_id: 8,
                    pat_first_name: 'Lisa',
                    pat_last_name: 'Martinez',
                    pat_insurance_no: 'INS008'
                }
            ];
        }

        function displayVitalSigns(vitalSignsToShow) {
            vitalSignsTable.clear();

            vitalSignsToShow.forEach(vital => {
                const patient = patients.find(p => p.pat_id === vital.pat_id);
                const patientName = patient ? `${patient.pat_first_name} ${patient.pat_last_name}` : 'Unknown';
                
                const status = getVitalStatus(vital);
                const statusBadge = `<span class="badge bg-${status.color}">${status.text}</span>`;
                
                const actions = `
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editVitalSigns(${vital.vital_id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewVitalSigns(${vital.vital_id})" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                `;

                vitalSignsTable.row.add([
                    formatDateTime(vital.recorded_date),
                    patientName,
                    vital.temperature ? `${vital.temperature}°F` : '-',
                    vital.blood_pressure_systolic && vital.blood_pressure_diastolic ? 
                        `${vital.blood_pressure_systolic}/${vital.blood_pressure_diastolic}` : '-',
                    vital.heart_rate ? `${vital.heart_rate} bpm` : '-',
                    vital.respiratory_rate ? `${vital.respiratory_rate}/min` : '-',
                    vital.oxygen_saturation ? `${vital.oxygen_saturation}%` : '-',
                    statusBadge,
                    actions
                ]);
            });
            
            vitalSignsTable.draw();
        }

        function getVitalStatus(vital) {
            // Simple vital signs assessment
            let criticalCount = 0;
            let warningCount = 0;

            // Temperature assessment
            if (vital.temperature) {
                if (vital.temperature < 95 || vital.temperature > 104) criticalCount++;
                else if (vital.temperature < 97 || vital.temperature > 100.4) warningCount++;
            }

            // Heart rate assessment
            if (vital.heart_rate) {
                if (vital.heart_rate < 50 || vital.heart_rate > 120) criticalCount++;
                else if (vital.heart_rate < 60 || vital.heart_rate > 100) warningCount++;
            }

            // Blood pressure assessment
            if (vital.blood_pressure_systolic && vital.blood_pressure_diastolic) {
                if (vital.blood_pressure_systolic > 180 || vital.blood_pressure_diastolic > 110) criticalCount++;
                else if (vital.blood_pressure_systolic > 140 || vital.blood_pressure_diastolic > 90) warningCount++;
            }

            if (criticalCount > 0) return { color: 'danger', text: 'Critical' };
            if (warningCount > 0) return { color: 'warning', text: 'Warning' };
            return { color: 'success', text: 'Normal' };
        }

        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayRecords = vitalSigns.filter(vital => vital.recorded_date && vital.recorded_date.startsWith(today)).length;
            
            let normal = 0, warning = 0, critical = 0;
            vitalSigns.forEach(vital => {
                const status = getVitalStatus(vital);
                if (status.color === 'success') normal++;
                else if (status.color === 'warning') warning++;
                else if (status.color === 'danger') critical++;
            });

            document.getElementById('todayRecords').textContent = todayRecords;
            document.getElementById('normalVitals').textContent = normal;
            document.getElementById('warningVitals').textContent = warning;
            document.getElementById('criticalVitals').textContent = critical;
        }

        function recordVitalSigns() {
            document.getElementById('vitalSignsModalTitle').textContent = 'Record Vital Signs';
            document.getElementById('vitalSignsForm').reset();
            document.getElementById('vitalSignsId').value = '';
            setDefaultDateTime();
            new bootstrap.Modal(document.getElementById('vitalSignsModal')).show();
        }

        async function saveVitalSigns() {
            const form = document.getElementById('vitalSignsForm');
            const formData = new FormData(form);
            const vitalData = {};
            
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    vitalData[key] = value;
                }
            }

            // Add nurse ID
            vitalData.nurse_id = user.entity_id || user.user_id;

            try {
                const response = await apiCall('/vital-signs', 'POST', vitalData);
                if (response) {
                    showAlert('Vital signs recorded successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('vitalSignsModal')).hide();
                    loadVitalSigns();
                }
            } catch (error) {
                showAlert('Error recording vital signs: ' + error.message, 'danger');
            }
        }

        function applyFilters() {
            const dateFilter = document.getElementById('filterDate').value;
            const patientFilter = document.getElementById('filterPatient').value;
            const searchTerm = document.getElementById('searchPatient').value.toLowerCase();

            let filtered = vitalSigns;

            if (dateFilter) {
                filtered = filtered.filter(vital => vital.recorded_date && vital.recorded_date.startsWith(dateFilter));
            }

            if (patientFilter) {
                filtered = filtered.filter(vital => vital.pat_id == patientFilter);
            }

            if (searchTerm) {
                filtered = filtered.filter(vital => {
                    const patient = patients.find(p => p.pat_id === vital.pat_id);
                    if (patient) {
                        return patient.pat_first_name.toLowerCase().includes(searchTerm) ||
                               patient.pat_last_name.toLowerCase().includes(searchTerm) ||
                               patient.pat_insurance_no.toLowerCase().includes(searchTerm);
                    }
                    return false;
                });
            }

            displayVitalSigns(filtered);
        }

        function clearFilters() {
            document.getElementById('filterDate').value = '';
            document.getElementById('filterPatient').value = '';
            document.getElementById('searchPatient').value = '';
            displayVitalSigns(vitalSigns);
        }

        function refreshVitalSigns() {
            loadVitalSigns();
        }

        function editVitalSigns(vitalId) {
            const vital = vitalSigns.find(v => v.vital_sign_id === vitalId);
            if (!vital) {
                showAlert('Vital signs record not found!', 'danger');
                return;
            }

            // Populate form with existing data
            document.getElementById('vitalSignModalTitle').textContent = 'Edit Vital Signs';
            document.getElementById('vitalSignId').value = vital.vital_sign_id;
            document.getElementById('patientSelect').value = vital.pat_id;
            document.getElementById('heartRate').value = vital.heart_rate || '';
            document.getElementById('systolicBP').value = vital.systolic_bp || '';
            document.getElementById('diastolicBP').value = vital.diastolic_bp || '';
            document.getElementById('temperature').value = vital.temperature || '';
            document.getElementById('weight').value = vital.weight || '';
            document.getElementById('height').value = vital.height || '';
            document.getElementById('oxygenSaturation').value = vital.oxygen_saturation || '';
            document.getElementById('respiratoryRate').value = vital.respiratory_rate || '';
            document.getElementById('recordedDate').value = formatDateTimeForInput(vital.recorded_date);
            document.getElementById('vitalNotes').value = vital.notes || '';

            // Change button text and function
            const submitBtn = document.querySelector('#vitalSignModal .btn-primary');
            submitBtn.textContent = 'Update Vital Signs';
            submitBtn.onclick = updateVitalSigns;

            new bootstrap.Modal(document.getElementById('vitalSignModal')).show();
        }

        async function updateVitalSigns() {
            const form = document.getElementById('vitalSignForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData(form);
            const vitalData = {};

            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    vitalData[key] = value;
                }
            }

            const vitalId = document.getElementById('vitalSignId').value;

            try {
                const response = await apiCall(`/vital-signs/${vitalId}`, 'PUT', vitalData);
                if (response) {
                    showAlert('Vital signs updated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('vitalSignModal')).hide();
                    loadVitalSigns();

                    // Reset button for next use
                    const submitBtn = document.querySelector('#vitalSignModal .btn-primary');
                    submitBtn.textContent = 'Save Vital Signs';
                    submitBtn.onclick = saveVitalSigns;
                }
            } catch (error) {
                showAlert('Error updating vital signs: ' + error.message, 'danger');
            }
        }

        function viewVitalSigns(vitalId) {
            const vital = vitalSigns.find(v => v.vital_sign_id === vitalId);
            if (!vital) {
                showAlert('Vital signs record not found!', 'danger');
                return;
            }

            const patient = patients.find(p => p.pat_id === vital.pat_id);
            const patientName = patient ? `${patient.pat_first_name} ${patient.pat_last_name}` : 'Unknown';

            const modalHtml = `
                <div class="modal fade" id="viewVitalModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Vital Signs Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Patient Information</h6>
                                        <table class="table table-borderless">
                                            <tr><td><strong>Patient:</strong></td><td>${patientName}</td></tr>
                                            <tr><td><strong>Patient ID:</strong></td><td>${vital.pat_id}</td></tr>
                                            <tr><td><strong>Recorded Date:</strong></td><td>${formatDateTime(vital.recorded_date)}</td></tr>
                                            <tr><td><strong>Recorded By:</strong></td><td>${user.first_name || ''} ${user.last_name || 'Nurse'}</td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Vital Signs</h6>
                                        <table class="table table-borderless">
                                            <tr><td><strong>Heart Rate:</strong></td><td>${vital.heart_rate ? vital.heart_rate + ' bpm' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>Blood Pressure:</strong></td><td>${vital.systolic_bp && vital.diastolic_bp ? vital.systolic_bp + '/' + vital.diastolic_bp + ' mmHg' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>Temperature:</strong></td><td>${vital.temperature ? vital.temperature + '°F' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>Weight:</strong></td><td>${vital.weight ? vital.weight + ' lbs' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>Height:</strong></td><td>${vital.height ? vital.height + ' inches' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>O2 Saturation:</strong></td><td>${vital.oxygen_saturation ? vital.oxygen_saturation + '%' : 'Not recorded'}</td></tr>
                                            <tr><td><strong>Respiratory Rate:</strong></td><td>${vital.respiratory_rate ? vital.respiratory_rate + ' breaths/min' : 'Not recorded'}</td></tr>
                                        </table>
                                    </div>
                                </div>
                                ${vital.notes ? `
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Notes</h6>
                                        <div class="alert alert-info">
                                            ${vital.notes}
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                <div class="row">
                                    <div class="col-12">
                                        <h6>Assessment</h6>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="card text-center ${getVitalStatusClass('heart_rate', vital.heart_rate)}">
                                                    <div class="card-body py-2">
                                                        <small>Heart Rate</small>
                                                        <div class="fw-bold">${getVitalStatus('heart_rate', vital.heart_rate)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card text-center ${getVitalStatusClass('blood_pressure', vital.systolic_bp)}">
                                                    <div class="card-body py-2">
                                                        <small>Blood Pressure</small>
                                                        <div class="fw-bold">${getVitalStatus('blood_pressure', vital.systolic_bp)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card text-center ${getVitalStatusClass('temperature', vital.temperature)}">
                                                    <div class="card-body py-2">
                                                        <small>Temperature</small>
                                                        <div class="fw-bold">${getVitalStatus('temperature', vital.temperature)}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-outline-primary" onclick="editVitalSigns(${vital.vital_sign_id}); bootstrap.Modal.getInstance(document.getElementById('viewVitalModal')).hide();">Edit</button>
                                <button type="button" class="btn btn-outline-info" onclick="printVitalSigns(${vital.vital_sign_id})">Print</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remove existing modal if any
            const existingModal = document.getElementById('viewVitalModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Add modal to body and show
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('viewVitalModal')).show();
        }

        function getVitalStatus(type, value) {
            if (!value) return 'Not Recorded';

            switch (type) {
                case 'heart_rate':
                    if (value < 60) return 'Low';
                    if (value > 100) return 'High';
                    return 'Normal';
                case 'blood_pressure':
                    if (value < 90) return 'Low';
                    if (value > 140) return 'High';
                    return 'Normal';
                case 'temperature':
                    if (value < 97) return 'Low';
                    if (value > 99.5) return 'High';
                    return 'Normal';
                default:
                    return 'Normal';
            }
        }

        function getVitalStatusClass(type, value) {
            const status = getVitalStatus(type, value);
            switch (status) {
                case 'High': return 'border-danger text-danger';
                case 'Low': return 'border-warning text-warning';
                case 'Normal': return 'border-success text-success';
                default: return 'border-secondary text-muted';
            }
        }

        function printVitalSigns(vitalId) {
            showAlert('Print functionality will be implemented soon', 'info');
        }

        function formatDateTimeForInput(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }

        // API helper function
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(endpoint, options);
            
            if (response.status === 401) {
                logout();
                return;
            }

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Request failed');
            }

            return result;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString();
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
